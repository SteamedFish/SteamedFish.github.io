<!DOCTYPE html>
<html lang="cn">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="SteamedFish ">
<meta name="description"
    content="问题 我们都知道文件包含以下这几个时间相关的属性： Access: 2019-04-26 14:56:17.086659763 &#43;0800 Modify: 2019-04-26 14:54:09.626659782 &#43;0800 Change: 2019-06-04 17:10:13.473326466 &#43;0800 Birth: 2019-04-26 14:53:42.413326457 &#43;0800 其中： Access 为最后一次读取文件内容的时间 Modify 为最后一次改变文件内容" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://blog.steamedfish.org/posts/2019/06/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%89%A7%E8%A1%8C-mv-%E4%B9%8B%E5%90%8E%E6%96%87%E4%BB%B6%E7%9A%84-ctime-%E4%BC%9A%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96/" />


<title>
    
    为什么执行 mv 之后，文件的 ctime 会发生变化？ :: SteamedFish&#39;s BLOG 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.d90905eb29b71569a516566cd9662312bee9ab021c760de6949cdc92d6688be9.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627">
<meta itemprop="name" content="为什么执行 mv 之后，文件的 ctime 会发生变化？">
<meta itemprop="description" content="问题 我们都知道文件包含以下这几个时间相关的属性： Access: 2019-04-26 14:56:17.086659763 &#43;0800 Modify: 2019-04-26 14:54:09.626659782 &#43;0800 Change: 2019-06-04 17:10:13.473326466 &#43;0800 Birth: 2019-04-26 14:53:42.413326457 &#43;0800 其中： Access 为最后一次读取文件内容的时间 Modify 为最后一次改变文件内容">


<meta itemprop="datePublished" content="2019-06-06T16:45:14&#43;08:00" />
<meta itemprop="dateModified" content="2019-06-06T16:45:14&#43;08:00" />
<meta itemprop="wordCount" content="608">



<meta itemprop="keywords" content="Linux," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="为什么执行 mv 之后，文件的 ctime 会发生变化？"/>
<meta name="twitter:description" content="问题 我们都知道文件包含以下这几个时间相关的属性： Access: 2019-04-26 14:56:17.086659763 &#43;0800 Modify: 2019-04-26 14:54:09.626659782 &#43;0800 Change: 2019-06-04 17:10:13.473326466 &#43;0800 Birth: 2019-04-26 14:53:42.413326457 &#43;0800 其中： Access 为最后一次读取文件内容的时间 Modify 为最后一次改变文件内容"/>




<meta property="article:published_time" content="2019-06-06 16:45:14 &#43;0800 CST" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://blog.steamedfish.org" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">hello</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://blog.steamedfish.org/posts/">Posts</a></li><li><a href="https://blog.steamedfish.org/about-hugo/">About</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>

            

            </p>
        </div>

        <article>
            <h1 class="post-title"><a href="https://blog.steamedfish.org/posts/2019/06/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%89%A7%E8%A1%8C-mv-%E4%B9%8B%E5%90%8E%E6%96%87%E4%BB%B6%E7%9A%84-ctime-%E4%BC%9A%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96/">为什么执行 mv 之后，文件的 ctime 会发生变化？</a></h1>

            

            <div class="post-content">
                <h1 id="问题">问题</h1>

<p>我们都知道文件包含以下这几个时间相关的属性：</p>

<p>Access: 2019-04-26 14:56:17.086659763 +0800
Modify: 2019-04-26 14:54:09.626659782 +0800
Change: 2019-06-04 17:10:13.473326466 +0800
 Birth: 2019-04-26 14:53:42.413326457 +0800</p>

<p>其中：</p>

<ul>
<li>Access 为最后一次读取文件内容的时间</li>
<li>Modify 为最后一次改变文件内容的时间</li>
<li>Change 为最后一次改变文件属性的时间</li>
<li>Birth 为文件创建的时间</li>
</ul>

<p>一个有趣的现象是，在对文件进行重命名操作的时候（=mv a b=），理论上，文件内容不会
被读取，该文件的内容和任何属性也不会被改变，但是它的 ctime，也就是 Change time，
却发生了变化。这是为什么呢？</p>

<h1 id="分析">分析</h1>

<p>让我们看一下 <a href="http://pubs.opengroup.org/onlinepubs/9699919799/functions/rename.html" title="POSIX 的规定">POSIX 的规定</a>，结果发现，POSIX 对此是未定义的：</p>

<p>Some implementations mark for update the last file status change timestamp of
renamed files and some do not. Applications which make use of the last file
status change timestamp may behave differently with respect to renamed files
unless they are designed to allow for either behavior.</p>

<p>于是我们只能去读源码了。</p>

<h1 id="源码分析">源码分析</h1>

<h2 id="ext4-的实现">ext4 的实现</h2>

<p>在 ext4 的 <a href="https://github.com/torvalds/linux/blob/master/fs/ext4/namei.c#L3727" title="源码">源码</a> 中，是直接强行修改了 ctime 的，还说大家都这样做：</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * Like most other Unix systems, set the ctime for inodes on a
</span><span class="cm"> * rename.
</span><span class="cm"> */</span>
<span class="n">old</span><span class="p">.</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">current_time</span><span class="p">(</span><span class="n">old</span><span class="p">.</span><span class="n">inode</span><span class="p">);</span></code></pre></div>
<h2 id="reiserfs-的实现">reiserfs 的实现</h2>

<p>在 reiserfs 的 <a href="https://github.com/torvalds/linux/blob/master/fs/reiserfs/namei.c#L1574" title="源码">源码</a> 中，也是强行修改了 ctime，还特意说明之前不修改是个 bug：</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm">  * thanks to Alex Adriaanse &lt;alex_a@caltech.edu&gt; for patch
</span><span class="cm">  * which adds ctime update of renamed object
</span><span class="cm">  */</span>
<span class="n">old_inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">ctime</span><span class="p">;</span></code></pre></div>
<h2 id="xfs-的实现">XFS 的实现</h2>

<p>感谢 XFS，在实现中给出了非常详细的解释，让我们终于明白为什么需要强行修改 ctime
了。我们看一下 <a href="https://github.com/torvalds/linux/blob/master/fs/xfs/xfs_inode.c#L3385" title="源码">源码</a>：</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * We always want to hit the ctime on the source inode.
</span><span class="cm"> *
</span><span class="cm"> * This isn&#39;t strictly required by the standards since the source
</span><span class="cm"> * inode isn&#39;t really being changed, but old unix file systems did
</span><span class="cm"> * it and some incremental backup programs won&#39;t work without it.
</span><span class="cm"> */</span>
<span class="n">xfs_trans_ichgtime</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">src_ip</span><span class="p">,</span> <span class="n">XFS_ICHGTIME_CHG</span><span class="p">);</span>
<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">src_ip</span><span class="p">,</span> <span class="n">XFS_ILOG_CORE</span><span class="p">);</span></code></pre></div>
<h1 id="结论">结论</h1>

<p>mv 文件的时候，确实不会修改文件的属性信息，理论上 ctime 是不会变化的。但是这样会
导致很多依赖于文件修改时间的程序（例如一些增量备份程序）出现 BUG，因此绝大多数文
件系统在处理 mv 操作的时候都强行修改了 ctime 时间。</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://blog.steamedfish.org/tags/linux">Linux</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-06-06 16:45 &#43;0800</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    

                    
                        <span class="button next">
                            <a href="https://blog.steamedfish.org/posts/2019/06/systemd-journal-%E5%8D%A0%E7%94%A8%E5%86%85%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98/">
                                <span class="button__text">systemd-journal 占用内存的问题</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2019</span>
            
                <span><a href="https://blog.steamedfish.org">SteamedFish</a></span>
            
            <span>SteamedFish's BLOG</span>
            <span> <a href="https://blog.steamedfish.org/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.9e52e68b082cf2a30a7fead88260edb8818fbd7f7831e39674917d4539ec75df41ba88eaddfbd916594ab4fb2a31913b46cf2d6094cf80381edb8c632512a8ca.js" integrity="sha512-nlLmiwgs8qMKf&#43;rYgmDtuIGPvX94MeOWdJF9RTnsdd9Buojq3fvZFllKtPsqMZE7Rs8tYJTPgDge24xjJRKoyg=="></script>



    </body>
</html>
